{% include 'core/header.html' %}
{% load static %} <!-- Carregar as tags estáticas -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa com Pesquisa por Endereço</title>

    <!-- Incluir o Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Incluir o Leaflet Control Geocoder -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <style>
        #map {
            width: 100%;
            height: 400px;
        }
    </style>
</head>

<div class="container">
   <div class="form-container">
      <form method="POST" enctype="multipart/form-data">
         {% csrf_token %}
         <div class="container">
            <div class="row">
               <div class="col-sm-6">
                 <img src="{% static 'img/cadastre-pet.png' %}" alt="Logo sos pets"  width="70%">
               </div>
               <div class="col-sm-6">
                  <!-- Dados do Pet -->
                  <div class="form-group">
                        <h1>Cadastro de Pet</h1>
                    <p>Preencha as informações abaixo para cadastrar um pet.</p>
                     <label for="tipo">Tipo:</label>
                     <select id="tipo" name="tipo" class="form-control" required>
                        <option value="">Selecione</option>
                        <option value="perdido">Perdido</option>
                        <option value="encontrado">Encontrado</option>
                     </select>
                  </div>
                  <div class="form-group">
                     <label for="nome">Nome do Pet:</label>
                     <input type="text" id="nome" name="nome" class="form-control" placeholder="Nome do pet" required>
                  </div>
                  <div class="form-group">
                     <label for="especie">Espécie:</label>
                     <select id="especie" name="especie" class="form-control" required>
                        <option value="">Selecione</option>
                        <option value="cachorro">Cachorro</option>
                        <option value="gato">Gato</option>
                     </select>
                  </div>
                  <div class="form-group">
                     <label for="porte">Porte:</label>
                     <select id="porte" name="porte" class="form-control" required>
                        <option value="">Selecione</option>
                        <option value="pequeno">Pequeno</option>
                        <option value="medio">Médio</option>
                        <option value="grande">Grande</option>
                     </select>
                  </div>
                  <div class="form-group">
                     <label for="cor">Cor:</label>
                     <input type="text" id="cor" name="cor" class="form-control" placeholder="Cor do pet" required>
                  </div>
                  <div class="form-group">
                     <label for="detalhes">Detalhes:</label>
                     <textarea id="detalhes" name="detalhes" class="form-control" placeholder="Detalhes adicionais sobre o pet" required></textarea>
                  </div>
                  <div class="form-group">
                     <label for="data_hora">Data e Hora:</label>
                     <input type="datetime-local" id="data_hora" name="data_hora" class="form-control" required>
                  </div>
                  <div class="form-group">
                     <label for="localizacao">Localização:</label>
                     <input type="text" id="localizacao" name="localizacao" class="form-control" placeholder="Local onde o pet foi visto" required>
                  </div>
                  <!-- Contato do Tutor -->
                  <div class="form-group">
                     <label for="email_contato">Email de Contato:</label>
                     <input type="email" id="email_contato" name="email_contato" class="form-control" placeholder="Email do tutor" required>
                  </div>
                  <div class="form-group">
                     <label for="telefone_contato">Telefone de Contato:</label>
                     <input type="tel" id="telefone_contato" name="telefone_contato" class="form-control" placeholder="Telefone do tutor" required>
                  </div>
                  <!-- Imagens do Pet -->
                  <h5>Imagens do Pet</h5>
                  <div class="form-group">
                     <label for="imagem1">Imagem 1:</label>
                     <input type="file" id="imagem1" name="imagem1" class="form-control" accept="image/*">
                  </div>
                  <div class="form-group">
                     <label for="imagem2">Imagem 2:</label>
                     <input type="file" id="imagem2" name="imagem2" class="form-control" accept="image/*">
                  </div>
                  <div class="form-group">
                     <label for="imagem3">Imagem 3:</label>
                     <input type="file" id="imagem3" name="imagem3" class="form-control" accept="image/*">
                  </div>
                  <!-- Campos de Latitude e Longitude -->
                  <input type="hidden" id="id_latitude" name="latitude">
                  <input type="hidden" id="id_longitude" name="longitude">
                  <br>
                  <div id="map"></div>
               <br>
                  <button type="submit" class="btn btn-primary btn-block">Cadastrar Pet</button>
                  {% if messages %}
                  <ul class="mt-3">
                     {% for message in messages %}
                     <li class="text-danger">{{ message }}</li>
                     {% endfor %}
                  </ul>
                  {% endif %}
               </div>
            </div>
         </div>
      </form>
   </div>
</div>

<script>
    // Função para truncar um número para N casas decimais
    function truncarNumero(num, casasDecimais) {
        let multiplicador = Math.pow(10, casasDecimais);
        return Math.floor(num * multiplicador) / multiplicador;
    }

    // Função que atualiza os campos hidden de latitude e longitude
    function onMapClick(e) {
        marker.setLatLng(e.latlng);
        let lat = truncarNumero(e.latlng.lat, 6);  // Truncando latitude para 6 casas decimais
        let lon = truncarNumero(e.latlng.lng, 6);  // Truncando longitude para 6 casas decimais
        document.getElementById("id_latitude").value = lat;
        document.getElementById("id_longitude").value = lon;
    }
    
    // Inicializa o mapa com a localização padrão
    let map = L.map('map').setView([-23.5505, -46.6333], 12);

    // Adiciona a camada de tiles do OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    // Cria o marcador inicial, que será movido ou atualizado pela pesquisa
    let marker = L.marker([-23.5505, -46.6333], {draggable: true}).addTo(map);

    map.on('click', onMapClick);

    marker.on('dragend', function (e) {
        let lat = truncarNumero(e.target.getLatLng().lat, 6);  // Truncando latitude para 6 casas decimais
        let lon = truncarNumero(e.target.getLatLng().lng, 6);  // Truncando longitude para 6 casas decimais
        document.getElementById("id_latitude").value = lat;
        document.getElementById("id_longitude").value = lon;
    });

    // Adiciona o controle de geocodificação (pesquisa por endereço)
    L.Control.geocoder({
        defaultMarkGeocode: false, // Evita que o marcador apareça automaticamente
        geocoder: new L.Control.Geocoder.Nominatim() // Usando o Nominatim do OpenStreetMap para geocodificação
    }).on('markgeocode', function(e) {
        // Ao buscar o endereço, move o marcador e atualiza as coordenadas
        let latlng = e.geocode.center;
        marker.setLatLng(latlng);
        map.setView(latlng, 14); // Zoma na localização
        let lat = truncarNumero(latlng.lat, 6);  // Truncando latitude para 6 casas decimais
        let lon = truncarNumero(latlng.lng, 6);  // Truncando longitude para 6 casas decimais
        document.getElementById("id_latitude").value = lat;
        document.getElementById("id_longitude").value = lon;
    }).addTo(map);

    // Adiciona a função de truncamento ao evento de envio do formulário
    document.querySelector('form').onsubmit = function() {
        let lat = parseFloat(document.getElementById("id_latitude").value);
        let lon = parseFloat(document.getElementById("id_longitude").value);
        
        if (isNaN(lat) || isNaN(lon)) {
            alert("Coordenadas inválidas. Por favor, selecione uma posição no mapa.");
            return false;  // Impede o envio do formulário
        }

        // Truncar as coordenadas para 6 casas decimais
        document.getElementById("id_latitude").value = truncarNumero(lat, 6);
        document.getElementById("id_longitude").value = truncarNumero(lon, 6);
        return true;  // Permite o envio do formulário
    };
</script>

{% include 'core/footer.html' %}
